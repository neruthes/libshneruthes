#!/bin/bash

# 18617a36be389e7cf8778a3ec5a45829
# refetchw=https://raw.githubusercontent.com/neruthes/NDevShellRC/refs/heads/master/bin/ntypst

#########################################################################################
# The 'ntypst' script
#
# Copyright (c) 2026 Neruthes (https://neruthes.xyz) (https://github.com/neruthes).
# Published with the MIT license (https://mit-license.org/).
#
# This script is a wrapper for the 'typst' binary, providing some additional data.
#########################################################################################


### Find file name
found_path=""
for arg in "$@"; do
    # Skip anything that starts with a hyphen
    if [[ "$arg" == -* ]]; then
        continue
    fi
    if [[ "$arg" == . ]]; then
        continue
    fi
    # Check if the path exists (file, dir, symlink, etc.)
    if [[ -e "$arg" ]]; then
        found_path="$arg"
        break
    fi
done
if [[ -n "$found_path" ]]; then
    # echo "Found path: $found_path"
    sha256sum="$(sha256sum "$found_path" | cut -d' ' -f1)"
    sha1sum="$(sha1sum "$found_path" | cut -d' ' -f1)"
    realpath "$found_path"
else
    # echo "No valid path argument found."
    sha256sum="NOT/AVAILABLE"
    sha1sum="NOT/AVAILABLE"
fi




### Real work
typst "$@" \
    --input ray="$(uuidgen v4)" \
    --input cmdline="$*" \
    --input pwd="$PWD" \
    --input hostname="$HOSTNAME" \
    --input user="$USER" \
    --input TZ="$(date +%Z)" \
    --input tz="$(date +%z)" \
    --input date="$(date -Is)" \
    --input time="$(date +%s)" \
    --input date_utc="$(TZ=UTC date -Is)" \
    --input time_utc="$(TZ=UTC date +%s)" \
    --input env="$(env)" \
    --input sha256sum="$sha256sum" \
    --input sha1sum="$sha1sum" \
    --input src="$(realpath --relative-to . "$found_path")"
    
