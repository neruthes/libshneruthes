#!/bin/bash

# f566b006cbcffc12dfd9035bb44d287261ef59b126ed89a3de35c925cab2f40d
# refetchw=https://raw.githubusercontent.com/neruthes/NDevShellRC/refs/heads/master/bin/refetchw

# ==========================================================
# Copyright (c) 2026 Neruthes.
# Released with the MIT license.
# ==========================================================

# ==========================================================
# Usage: 
#       $ refetchw path/to/file
#
#
# If file contains `refetchw=` substring, this script will
# fetch the latest online version and overwrite local file.
# Non-alphanumerical leading characters are allowed.
# ==========================================================




[[ -z "$ENABLE_DATE_CHECK" ]] && ENABLE_DATE_CHECK=n




function _die() {
    echo "$2" > /dev/stderr
    exit "$1"
}

echo "$1"
[[ -n "$1" ]] || _die 1 "[FATAL] Must supply file path!"
[[ -e "$1" ]] || _die 2 "[FATAL] File not found at path!"



### Early exit if is canonical
magic_hash="$(echo -n "refetchw:$(realpath "$1")" | sha256sum | cut -c1-32)"
if grep -qs "$magic_hash" "$1"; then
    _die 4 "[FATAL] File local path is canonical!"
fi


### Get upstream URL
if ! grep -qs "refetchw=" "$1"; then
    _die 3 "[FATAL] File does not contain upstream URL!"
fi


if [[ "$ENABLE_DATE_CHECK" != n ]]; then
    if [[ -n "$(find "$0" -mtime +7)" ]]; then ### Old enough
        echo "[INFO] File is old enough; refetching..."
    else
        _die 4 "Not old enough!"
    fi
else
    echo "[INFO] Skipping date check..."
fi

# TODO: Ignore lines with alphanumerical leading characters



function _get_upstream_url() {
    local file_path="$1"
    grep "refetchw=" "$file_path" | head -n1 | cut -d= -f2-
}
upstream_url="$(_get_upstream_url "$1")"




### Refetching now!
echo "[INFO] Refetching now!"
echo "[INFO] upstream_url=$upstream_url"

curl --retry 20 "$upstream_url" > "$1.tmp" || _die 25 "[FATAL] Cannot download updated self"

mv -v "$1.tmp" "$1"
